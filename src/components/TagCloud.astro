---
import { getCollection } from "astro:content";
import TechIcon from "./TechIcon.astro";

// 暫定的な型定義
interface BlogPostData {
    title: string;
    description: string;
    pubDate: Date;
    updatedDate?: Date;
    heroImage?: ImageMetadata;
    categories?: string[];
    draft?: boolean;
}

const allPosts = await getCollection("blog", (post) => {
    const data = post.data as unknown as BlogPostData;
    return import.meta.env.PROD ? data.draft !== true : true;
});

const categories = allPosts
    .flatMap((post) => (post.data as unknown as BlogPostData).categories || [])
    .filter((cat) => typeof cat === "string" && cat.trim().length > 0);

const { showCount = true, initialCollapsed = false } = Astro.props;

const categoryCounts = categories.reduce(
    (acc, cat) => {
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
    },
    {} as Record<string, number>,
);

const uniqueCategories = Object.keys(categoryCounts).sort();

// フォントサイズの計算用
const maxCount = Math.max(...Object.values(categoryCounts));
const minCount = Math.min(...Object.values(categoryCounts));

// Prepare data for the new structure
const sortedTags = uniqueCategories
    .map((name) => ({
        name,
        count: categoryCounts[name],
    }))
    .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));

const newMaxCount =
    sortedTags.length > 0 ? Math.max(...sortedTags.map((tag) => tag.count)) : 1;
---

<div
    class:list={["tag-cloud glass-panel", { collapsed: initialCollapsed }]}
    id="tech-stack-container"
>
    <h3 id="tech-stack-header" class="clickable-header">
        Tech Stack & Categories
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="chevron-icon"
        >
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </h3>
    <div class="tag-cloud-content-wrapper" id="tech-stack-content">
        <div class="tags-grid">
            {
                sortedTags.map((tag) => (
                    <a href={`/categories/${tag.name}/`} class="tag-card">
                        <div class="icon-box">
                            <TechIcon name={tag.name} />
                        </div>
                        <span class="tag-name">{tag.name}</span>
                        {showCount && (
                            <span class="tag-count">{tag.count}</span>
                        )}
                    </a>
                ))
            }
        </div>
    </div>
</div>

<style>
    .tag-cloud {
        padding: 1.5rem 2rem;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        box-shadow:
            0 10px 40px rgba(0, 0, 0, 0.03),
            inset 0 0 0 1px rgba(255, 255, 255, 0.3);
        overflow: hidden;
        position: relative;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Decoration background */
    .tag-cloud::before {
        content: "";
        position: absolute;
        top: -100px;
        right: -100px;
        width: 300px;
        height: 300px;
        background: radial-gradient(
            circle,
            rgba(var(--accent), 0.08) 0%,
            transparent 70%
        );
        filter: blur(40px);
        z-index: 0;
        pointer-events: none;
    }

    .tag-cloud h3 {
        margin: 0;
        font-size: 1.1rem;
        color: rgb(var(--gray-dark));
        font-weight: 700;
        letter-spacing: 0.05em;
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        cursor: pointer;
        user-select: none;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(var(--gray), 0.1);
        transition: border-color 0.3s;
    }

    .tag-cloud h3:hover {
        border-bottom-color: rgba(var(--accent), 0.3);
        color: rgb(var(--black));
    }

    /* Chevron icon rotation */
    .chevron-icon {
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        color: rgba(var(--gray), 0.6);
    }

    .tag-cloud.collapsed .chevron-icon {
        transform: rotate(-90deg);
    }

    .tag-cloud h3:hover .chevron-icon {
        color: var(--accent);
    }

    /* Content wrapper for smooth height transition */
    .tag-cloud-content-wrapper {
        display: grid;
        grid-template-rows: 1fr;
        transition:
            grid-template-rows 0.4s cubic-bezier(0.16, 1, 0.3, 1),
            margin-top 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        margin-top: 1.5rem;
    }

    .tag-cloud.collapsed .tag-cloud-content-wrapper {
        grid-template-rows: 0fr;
        margin-top: 0;
    }

    .tags-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        position: relative;
        z-index: 1;
        overflow: hidden;
        min-height: 0;
        padding-top: 0.2rem;
    }

    .tag-card {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.8rem;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 10px;
        text-decoration: none;
        color: rgb(var(--gray-dark));
        transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;
        font-weight: 500;
        font-size: 0.85rem;
        backdrop-filter: blur(4px);
    }

    .tag-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(var(--accent), 0.4);
        box-shadow:
            0 8px 16px -4px rgba(var(--accent), 0.15),
            0 2px 4px -1px rgba(0, 0, 0, 0.05);
        color: rgb(var(--black));
        padding-right: 2.2rem; /* Make space for the count revealing effect (optional) or just general spacing */
    }

    /* Gradient Shine Effect */
    .tag-card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            120deg,
            transparent 0%,
            transparent 20%,
            rgba(255, 255, 255, 0.6) 50%,
            transparent 80%,
            transparent 100%
        );
        transform: translateX(-150%) skewX(-20deg);
        transition: transform 0.6s;
    }

    .tag-card:hover::after {
        transform: translateX(150%) skewX(-20deg);
        transition-duration: 0.8s;
    }

    .icon-box {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.25em;
        height: 1.25em;
        transition: transform 0.3s ease;
        opacity: 0.9;
    }

    .tag-card:hover .icon-box {
        transform: scale(1.1) rotate(5deg);
        opacity: 1;
    }

    .tag-name {
        position: relative;
        z-index: 1;
    }

    .tag-count {
        background: rgba(var(--gray), 0.1);
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 12px;
        color: rgb(var(--gray));
        font-weight: 600;
        min-width: 1.4em;
        text-align: center;
        transition: all 0.3s ease;
    }

    .tag-card:hover .tag-count {
        background: var(--accent);
        color: #fff;
    }
</style>

<script>
    // Toggle functionality for the tech stack section
    function initTechStackToggle() {
        // Use a more specific selector or process all instances
        const containers = document.querySelectorAll(".tag-cloud");

        containers.forEach((container) => {
            const header = container.querySelector("h3");
            if (header) {
                // Remove existing listeners to be safe with View Transitions
                const newHeader = header.cloneNode(true);
                header.parentNode?.replaceChild(newHeader, header);

                newHeader.addEventListener("click", () => {
                    container.classList.toggle("collapsed");
                });
            }
        });
    }

    // Initialize on page load and after Astro view transitions
    document.addEventListener("astro:page-load", initTechStackToggle);
    // Also run immediately in case of simple load
    initTechStackToggle();
</script>
