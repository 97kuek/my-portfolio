---
import { getCollection } from "astro:content";
import TechIcon from "./TechIcon.astro";

// 暫定的な型定義
interface BlogPostData {
    title: string;
    description: string;
    pubDate: Date;
    updatedDate?: Date;
    heroImage?: ImageMetadata;
    categories?: string[];
    draft?: boolean;
}

const allPosts = await getCollection("blog", (post) => {
    const data = post.data as unknown as BlogPostData;
    return import.meta.env.PROD ? data.draft !== true : true;
});

const categories = allPosts
    .flatMap((post) => (post.data as unknown as BlogPostData).categories || [])
    .filter((cat) => typeof cat === "string" && cat.trim().length > 0);

const { showCount = true } = Astro.props;

const categoryCounts = categories.reduce(
    (acc, cat) => {
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
    },
    {} as Record<string, number>,
);

const uniqueCategories = Object.keys(categoryCounts).sort();

// フォントサイズの計算用
const maxCount = Math.max(...Object.values(categoryCounts));
const minCount = Math.min(...Object.values(categoryCounts));

// Prepare data for the new structure
const sortedTags = uniqueCategories
    .map((name) => ({
        name,
        count: categoryCounts[name],
    }))
    .sort((a, b) => a.name.localeCompare(b.name));

const newMaxCount =
    sortedTags.length > 0 ? Math.max(...sortedTags.map((tag) => tag.count)) : 1;
---

<div class="tag-cloud glass-panel">
    <h3>Tech Stack</h3>
    <div class="tags">
        {
            sortedTags.map((tag) => (
                <a
                    href={`/categories/${tag.name}/`}
                    class="tag"
                    style={`font-size: ${1 + (tag.count / newMaxCount) * 0.5}rem; opacity: ${0.8 + (tag.count / newMaxCount) * 0.2}`}
                >
                    <TechIcon name={tag.name} />
                    {tag.name} {showCount && `(${tag.count})`}
                </a>
            ))
        }
    </div>
</div>

<style>
    .tag-cloud {
        padding: 1.5rem;
        border-radius: 12px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
    }
    .tag-cloud h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: rgb(var(--black));
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--glass-border);
        padding-bottom: 0.5rem;
    }
    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        align-items: baseline;
    }
    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.3em;
        text-decoration: none;
        color: rgb(var(--gray-dark));
        transition: color 0.2s ease;
        line-height: 1;
    }
    .tag:hover {
        color: var(--accent);
        transform: translateY(-2px);
    }
    .count {
        font-size: 0.7em;
        opacity: 0.6;
        margin-left: 2px;
    }
</style>
