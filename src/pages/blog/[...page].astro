---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import TagCloud from '../../components/TagCloud.astro';
import Search from '../../components/Search.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection('blog');
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  return paginate(sortedPosts, { pageSize: 6 });
}

const { page } = Astro.props;
const allPosts = await getCollection('blog'); // For sidebar (tags/archive)
const tags = [...new Set(allPosts.map((post) => post.data.tags).flat())].filter(Boolean);
const months = [...new Set(allPosts.map(post => {
    const d = post.data.pubDate;
    return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
}))].sort().reverse();
---

<!doctype html>
<html lang="ja">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em;
			}

			.container {
				display: grid;
				grid-template-columns: 1fr 240px;
				gap: 3rem;
			}

			@media (max-width: 720px) {
				.container { grid-template-columns: 1fr; }
			}

			ul {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			
			ul li { width: 100%; }
			
			/* カード全体をリンクとして機能させる */
			.card {
				display: flex;
				flex-direction: column;
				text-decoration: none;
				transition: all 0.2s ease-in-out;
				height: 100%;
				border-radius: 12px;
				overflow: hidden;
				background: var(--glass-bg);
				border: 1px solid var(--glass-border);
				color: inherit; /* テキストの色を継承 */
			}

			.card:hover {
				transform: translateY(-4px);
				box-shadow: 0 12px 24px rgba(0,0,0,0.1);
				border-color: var(--accent);
			}

			.card-image-wrapper {
				width: 100%;
				aspect-ratio: 16 / 9;
				overflow: hidden;
			}

			.card img {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transition: transform 0.3s ease;
			}

			.card:hover img {
				transform: scale(1.05);
			}

			.content {
				padding: 1.25rem;
				display: flex;
				flex-direction: column;
				flex-grow: 1; /* コンテンツ部分を伸ばしてタグを下に固定 */
			}

			.title {
				margin: 0.5rem 0;
				color: rgb(var(--black));
				font-size: 1.15rem;
				line-height: 1.4;
				font-weight: bold;
			}

			.date {
				font-size: 0.8rem;
				color: rgb(var(--gray));
				margin: 0;
			}

			/* カード内のタグ */
			.card-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.4rem;
				margin-top: auto; /* 下端に寄せる */
				padding-top: 1rem;
			}
			
			.tag-badge {
				font-size: 0.7rem;
				background: rgba(var(--gray-light), 0.5);
				color: rgb(var(--gray));
				padding: 0.2rem 0.5rem;
				border-radius: 4px;
			}

			/* サイドバー */
			aside { display: flex; flex-direction: column; gap: 2rem; }
			.sidebar-section h3 {
				font-size: 0.9rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				border-bottom: 2px solid var(--glass-border);
				padding-bottom: 0.5rem;
				margin-bottom: 1rem;
				color: rgb(var(--gray));
			}
			.tag-list {
				list-style: none;
				padding: 0;
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}
			.archive-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.5rem; }
			.sidebar-link {
				font-size: 0.9rem;
				text-decoration: none;
				color: rgb(var(--gray-dark));
				transition: color 0.2s;
			}
			.sidebar-link:hover { color: var(--accent); }
			.tag.sidebar-link {
				background: var(--glass-bg);
				border: 1px solid var(--glass-border);
				padding: 0.2rem 0.6rem;
				border-radius: 100px;
			}

            /* ページネーション */
            .pagination {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-top: 3rem;
            }
            .pagination a {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.8rem 1.5rem;
                border-radius: 50px;
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                color: rgb(var(--black));
                text-decoration: none;
                transition: all 0.2s;
                font-weight: bold;
            }
            .pagination a:hover {
                background: var(--accent);
                color: #fff;
                transform: translateY(-2px);
            }
            .pagination-disabled {
                opacity: 0.5;
                pointer-events: none;
            }

		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="container">
				<section>
					<ul>
						{
							page.data.map((post) => (
								<li>
									{/* URLを /blog/${post.slug}/ に変更してみる（Astroのバージョンによってidかslugか異なります） */}
									<a href={`/blog/${post.id}/`} class="card">
										<div class="card-image-wrapper">
											{post.data.heroImage ? (
												<Image width={720} height={360} src={post.data.heroImage} alt="" />
											) : (
												<div style="background: rgba(var(--gray-light), 0.5); width: 100%; height: 100%;"></div>
											)}
										</div>
										<div class="content">
											<p class="date">
												<FormattedDate date={post.data.pubDate} />
											</p>
											<h4 class="title">{post.data.title}</h4>
											
											{post.data.tags && (
												<div class="card-tags">
													{post.data.tags.map((tag) => (
														<span class="tag-badge">#{tag}</span>
													))}
												</div>
											)}
										</div>
									</a>
								</li>
							))
						}
					</ul>

                    <div class="pagination">
                        {page.url.prev ? (
                            <a href={page.url.prev}>&larr; Prev</a>
                        ) : (
                            <span />
                        )}
                        {page.url.next ? (
                            <a href={page.url.next}>Next &rarr;</a>
                        ) : (
                            <span />
                        )}
                    </div>
				</section>

				<aside>
                    <Search />
					<TagCloud />
					
					<div class="sidebar-section">
						<h3>Archive</h3>
						<ul class="archive-list">
							{months.map(month => (
								<li><a href={`/archive/${month}/`} class="sidebar-link">{month}</a></li>
							))}
						</ul>
					</div>
				</aside>
			</div>
		</main>
		<Footer />
	</body>
</html>