---
import { getCollection } from "astro:content";
import BaseHead from "../../../components/BaseHead.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../../consts";
import PostCard from "../../../components/PostCard.astro";
import TagCloud from "../../../components/TagCloud.astro";

export async function getStaticPaths() {
	const allPosts = await getCollection("blog", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});

	// すべての記事から「年/月」の組み合わせを抽出
	const archiveMap = allPosts.map((post) => {
		const d = post.data.pubDate;
		return {
			year: d.getFullYear().toString(),
			month: (d.getMonth() + 1).toString().padStart(2, "0"),
		};
	});

	// 重複を削除
	const uniqueMonths = Array.from(
		new Set(archiveMap.map((m) => `${m.year}-${m.month}`)),
	).map((s) => {
		const [year, month] = s.split("-");
		return { year, month };
	});

	return uniqueMonths.map(({ year, month }) => {
		const filteredPosts = allPosts
			.filter((post) => {
				const d = post.data.pubDate;
				return (
					d.getFullYear().toString() === year &&
					(d.getMonth() + 1).toString().padStart(2, "0") === month
				);
			})
			.sort(
				(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
			);

		return {
			params: { year, month },
			props: { posts: filteredPosts },
		};
	});
}

const { year, month } = Astro.params;
const { posts } = Astro.props;

// サイドバー用のデータ取得 (Archive List)
const allPosts = await getCollection("blog", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

const months = [
	...new Set(
		allPosts.map((post) => {
			const d = post.data.pubDate;
			return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, "0")}`;
		}),
	),
]
	.sort()
	.reverse();
---

<!doctype html>
<html lang="ja">
	<head>
		<BaseHead
			title={`${year}年${month}月の記事一覧 | ${SITE_TITLE}`}
			description={SITE_DESCRIPTION}
		/>
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em;
			}

			.container {
				display: grid;
				grid-template-columns: 1fr 240px;
				grid-template-areas:
					"main sidebar-top"
					"main sidebar-bottom";
				gap: 3rem;
				align-items: start;
			}

			/* Main Content Area */
			.content-area {
				grid-area: main;
			}

			/* Sidebar Areas */
			.sidebar-top {
				grid-area: sidebar-top;
			}

			.sidebar-bottom {
				grid-area: sidebar-bottom;
			}

			@media (max-width: 720px) {
				.container {
					grid-template-columns: 1fr;
					grid-template-areas:
						"sidebar-top"
						"main"
						"sidebar-bottom";
					gap: 2rem;
				}
			}

			ul {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}

			ul li {
				width: 100%;
			}

			/* サイドバー */
			aside {
				display: flex;
				flex-direction: column;
				gap: 2rem;
			}
			.sidebar-section h3 {
				font-size: 0.9rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				border-bottom: 2px solid var(--glass-border);
				padding-bottom: 0.5rem;
				margin-bottom: 1rem;
				color: rgb(var(--gray));
			}
			.archive-list {
				list-style: none;
				padding: 0;
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.sidebar-link {
				font-size: 0.9rem;
				text-decoration: none;
				color: rgb(var(--gray-dark));
				transition: color 0.2s;
			}
			.sidebar-link:hover {
				color: var(--accent);
			}

			/* Page Header */
			.page-header {
				margin-bottom: 2rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid var(--glass-border);
			}
			.page-header h2 {
				margin: 0;
				font-size: 1.5rem;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="container">
				<section class="content-area">
					<div class="page-header">
						<h2>
							Archive: <span style="color: var(--accent);"
								>{year}/{month}</span
							>
						</h2>
					</div>

					<ul>
						{
							posts.map((post) => {
								return (
									<li>
										<PostCard post={post} />
									</li>
								);
							})
						}
					</ul>
				</section>

				<aside class="sidebar-top">
					<TagCloud />
				</aside>

				<aside class="sidebar-bottom">
					<div class="sidebar-section">
						<h3>Archive</h3>
						<ul class="archive-list">
							{
								months.map((m) => (
									<li>
										<a
											href={`/archive/${m}/`}
											class="sidebar-link"
										>
											{m}
										</a>
									</li>
								))
							}
						</ul>
					</div>
				</aside>
			</div>
		</main>
		<Footer />
	</body>
</html>
