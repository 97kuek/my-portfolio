---
import { Image } from "astro:assets";
import defaultImage from "../assets/blog-placeholder-new.png";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import ShareButtons from "../components/ShareButtons.astro";
import "katex/dist/katex.min.css";
import Giscuss from "../components/Giscuss.astro";
import PostCard from "../components/PostCard.astro";
import TechIcon from "../components/TechIcon.astro";

// Propsの型を拡張
type Props = CollectionEntry<"blog">["data"] & {
    prevPost?: CollectionEntry<"blog">;
    nextPost?: CollectionEntry<"blog">;
    relatedPosts?: CollectionEntry<"blog">[];
    headings?: { depth: number; slug: string; text: string }[];
    categories?: string[];
};

const {
    title,
    description,
    pubDate,
    updatedDate,
    heroImage,
    prevPost,
    nextPost,
    relatedPosts,
    headings,
    categories,
} = Astro.props;
---

<html lang="ja">
    <head>
        <BaseHead title={title} description={description} />

        {/* JSON-LD Structured Data */}
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                headline: title,
                image: [
                    new URL(
                        heroImage?.src ?? "/og-image.png",
                        Astro.site,
                    ).toString(),
                ],
                datePublished: pubDate.toISOString(),
                dateModified:
                    updatedDate?.toISOString() ?? pubDate.toISOString(),
                author: [
                    {
                        "@type": "Person",
                        name: "Keitaro Ueki",
                        url: Astro.site,
                    },
                ],
            })}
        />

        <style>
            /* --- レイアウト全体 --- */
            main {
                width: calc(100% - 2em);
                max-width: 100%;
                margin: 0;
            }

            .hero-image {
                width: 720px;
                max-width: 100%;
                margin: 0 auto 2em auto;
            }
            .hero-image img {
                display: block;
                margin: 0 auto;
                border-radius: 12px;
                box-shadow: var(--box-shadow);
                height: auto;
            }

            /* --- 本文エリア --- */
            .prose {
                width: 720px;
                max-width: calc(100% - 2em);
                margin: auto;
                padding: 1em;
                color: rgb(var(--gray-dark));
                font-size: 16px;
                line-height: 1.7;
            }

            /* Markdown内の見出しサイズを調整 
			   :global() を使うことで <slot /> 内の要素を確実に制御します 
			*/
            .prose :global(h1) {
                font-size: 1.3em; /* Markdown内の # */
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                line-height: 1.3;
            }

            .prose :global(h2) {
                font-size: 1.15em; /* Markdown内の ## (ここを小さくしました) */
                margin-top: 1.8em;
                margin-bottom: 0.6em;
                border-bottom: 1px solid var(--glass-border);
                padding-bottom: 0.3em;
                line-height: 1.4;
                color: rgb(var(--black));
            }

            .prose :global(h3) {
                font-size: 1.05em; /* Markdown内の ### */
                margin-top: 1.5em;
                margin-bottom: 0.5em;
            }

            /* --- 記事冒頭のメインタイトル --- */
            .title {
                margin-bottom: 1em;
                padding: 1em 0;
                text-align: center;
                line-height: 1.2;
            }
            .title h1 {
                font-size: 1.6rem; /* ページ最上部のタイトル */
                margin: 0 0 0.5em 0;
            }

            @media (max-width: 600px) {
                .title h1 {
                    font-size: 1.8rem;
                }
                .hero-image {
                    margin-bottom: 1.5rem;
                }
            }
            .date {
                margin-bottom: 0.5em;
                color: rgb(var(--gray));
            }

            /* Mobile optimization for prose content */
            @media (max-width: 600px) {
                .prose {
                    padding: 0.5em;
                }
                .prose :global(h1) {
                    font-size: 1.25em;
                    margin-top: 1.2em;
                }
                .prose :global(h2) {
                    font-size: 1.15em;
                    margin-top: 1.5em;
                }
                .prose :global(pre) {
                    padding: 1em;
                    border-radius: 8px;
                }
                .prose :global(img) {
                    border-radius: 8px;
                }
            }

            /* --- Tech Stack (Tags) --- */
            .tech-stack {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                flex-wrap: wrap;
                margin-bottom: 0.5rem;
            }
            .tech-badge {
                background: rgba(var(--accent), 0.1);
                color: var(--accent);
                border: 1px solid rgba(var(--accent), 0.2);
                padding: 0.25em 0.8em;
                border-radius: 20px;
                font-size: 0.85rem;
                text-decoration: none;
                transition: all 0.2s;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
                gap: 0.3em;
            }
            .tech-badge:hover {
                background: var(--accent);
                color: white;
                transform: translateY(-1px);
            }

            /* --- 目次 --- */
            .toc {
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 3rem;
            }
            .toc-title {
                font-weight: bold;
                margin: 0 0 0.5rem 0;
                font-size: 1.1rem;
                color: rgb(var(--black));
            }
            .toc ul {
                list-style-type: none;
                padding: 0;
                margin: 0;
            }
            .toc li {
                margin-bottom: 0.5rem;
                line-height: 1.4;
            }
            .toc li.depth-3 {
                padding-left: 1.5rem;
                font-size: 0.95em;
            }
            .toc a {
                color: rgb(var(--gray-dark));
                text-decoration: none;
                transition: color 0.2s;
            }
            .toc a:hover {
                color: var(--accent);
                text-decoration: underline;
            }

            /* --- 関連記事 --- */
            .related-posts {
                margin: 4rem 0 2rem;
                padding-top: 2rem;
                border-top: 1px solid var(--glass-border);
            }
            .related-posts h3 {
                font-size: 1.2rem;
                margin-bottom: 1.5rem;
                color: rgb(var(--black));
            }
            .related-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 2rem;
            }
            .related-card-wrapper {
                height: 100%;
            }

            /* --- 記事前後のナビゲーション --- */
            .post-navigation {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin: 2rem 0;
                padding-top: 2rem;
                border-top: 1px solid rgba(var(--gray), 0.2);
            }

            .nav-card {
                display: flex;
                flex-direction: column;
                padding: 1rem;
                text-decoration: none;
                color: inherit;
                border: 1px solid rgba(var(--gray), 0.2);
                border-radius: 8px;
                transition: all 0.2s ease;
            }

            .nav-card:hover {
                border-color: rgb(var(--accent));
                background-color: rgba(var(--accent), 0.05);
            }

            .nav-card .label {
                font-size: 0.8rem;
                color: rgb(var(--gray));
                margin-bottom: 0.5rem;
            }

            .nav-card .nav-title {
                font-weight: bold;
                font-size: 0.95rem;
                line-height: 1.4;
                color: rgb(var(--black));
            }

            .next {
                text-align: right;
            }

            @media (max-width: 600px) {
                .post-navigation {
                    grid-template-columns: 1fr;
                }
            }

            /* --- 読了プログレスバー --- */
            .reading-progress-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: transparent;
                z-index: 1000;
                pointer-events: none;
            }

            .reading-progress-bar {
                height: 100%;
                background: linear-gradient(90deg, var(--accent), #a37be7);
                width: 0%;
                transition: width 0.1s ease-out;
            }

            /* --- Back to Top ボタン --- */
            .back-to-top {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                width: 3rem;
                height: 3rem;
                background: rgba(var(--gray-dark), 0.8);
                color: white;
                border: none;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                opacity: 0;
                visibility: hidden;
                transform: translateY(20px);
                transition: all 0.3s ease;
                z-index: 900;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .back-to-top.visible {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .back-to-top:hover {
                background: require(
                    "var(--accent)"
                ); /* var(--accent) を使う場合 */
                background: rgb(var(--accent));
                transform: translateY(-4px);
            }
        </style>
    </head>

    <body>
        <!-- 読了プログレスバー -->
        <div class="reading-progress-container">
            <div class="reading-progress-bar" id="reading-progress-bar"></div>
        </div>

        <Header />
        <main>
            <Breadcrumbs />
            <article>
                <div class="hero-image">
                    <Image
                        width={1020}
                        height={510}
                        src={heroImage || defaultImage}
                        alt=""
                        loading="eager"
                    />
                </div>
                <div class="prose">
                    <div class="title">
                        <div class="date">
                            <FormattedDate date={pubDate} />
                            {
                                updatedDate && (
                                    <div class="last-updated-on">
                                        Last updated on{" "}
                                        <FormattedDate date={updatedDate} />
                                    </div>
                                )
                            }
                            <span class="reading-time-container">
                                • <span id="reading-time">計算中...</span>
                            </span>
                        </div>
                        {
                            categories && categories.length > 0 && (
                                <div class="tech-stack">
                                    {categories.map((cat) => (
                                        <a
                                            href={`/categories/${cat}/`}
                                            class="tech-badge"
                                        >
                                            <TechIcon name={cat} />
                                            {cat}
                                        </a>
                                    ))}
                                </div>
                            )
                        }
                        <h1>{title}</h1>
                        <hr />
                    </div>

                    {
                        headings && headings.length > 0 && (
                            <div class="toc">
                                <p class="toc-title">目次</p>
                                <ul>
                                    {headings
                                        .filter((h) => h.depth <= 3)
                                        .map((h) => (
                                            <li class={`depth-${h.depth}`}>
                                                <a href={`#${h.slug}`}>
                                                    {h.text}
                                                </a>
                                            </li>
                                        ))}
                                </ul>
                            </div>
                        )
                    }

                    {/* Markdownの中身がここに展開されます */}
                    <slot />

                    <ShareButtons title={title} url={Astro.url} />

                    <Giscuss />

                    {
                        relatedPosts && relatedPosts.length > 0 && (
                            <div class="related-posts">
                                <h3>関連記事</h3>
                                <div class="related-grid">
                                    {relatedPosts.map((post) => (
                                        <div class="related-card-wrapper">
                                            <PostCard post={post} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )
                    }

                    <nav class="post-navigation">
                        {
                            prevPost ? (
                                <a
                                    href={`/blog/${prevPost.id}/`}
                                    class="nav-card prev"
                                >
                                    <span class="label">← 前の記事</span>
                                    <span class="nav-title">
                                        {prevPost.data.title}
                                    </span>
                                </a>
                            ) : (
                                <div />
                            )
                        }

                        {
                            nextPost ? (
                                <a
                                    href={`/blog/${nextPost.id}/`}
                                    class="nav-card next"
                                >
                                    <span class="label">次の記事 →</span>
                                    <span class="nav-title">
                                        {nextPost.data.title}
                                    </span>
                                </a>
                            ) : (
                                <div />
                            )
                        }
                    </nav>
                </div>
            </article>
        </main>
        <Footer />

        <!-- Back to Top Button -->
        <button id="back-to-top" class="back-to-top" aria-label="Topへ戻る">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="M18 15l-6-6-6 6"></path>
            </svg>
        </button>
        <script>
            // スクロール関連のロジック
            function initScrollEffects() {
                // --- 読了時間計算 (既存) ---
                const articleBody = document.querySelector(".prose");
                if (articleBody) {
                    const text = articleBody.textContent || "";
                    const wordCount = text.length;
                    const readingTime = Math.ceil(wordCount / 500);
                    const readingTimeElement =
                        document.getElementById("reading-time");
                    if (readingTimeElement) {
                        readingTimeElement.textContent = `約 ${readingTime} 分で読めます`;
                    }
                }

                // --- プログレスバー & Back to Top ---
                const progressBar = document.getElementById(
                    "reading-progress-bar",
                );
                const backToTopBtn = document.getElementById("back-to-top");

                function handleScroll() {
                    const scrollTop =
                        window.scrollY || document.documentElement.scrollTop;
                    const docHeight =
                        document.documentElement.scrollHeight -
                        document.documentElement.clientHeight;

                    // プログレスバーの更新
                    if (progressBar && docHeight > 0) {
                        const scaffold = (scrollTop / docHeight) * 100;
                        progressBar.style.width = `${scaffold}%`;
                    }

                    // Back to Top ボタンの表示切り替え
                    if (backToTopBtn) {
                        if (scrollTop > 300) {
                            backToTopBtn.classList.add("visible");
                        } else {
                            backToTopBtn.classList.remove("visible");
                        }
                    }
                }

                // スクロールイベントの登録
                window.addEventListener("scroll", handleScroll, {
                    passive: true,
                });
                handleScroll(); // 初期化時にも実行

                // Back to Top クリックイベント
                if (backToTopBtn) {
                    backToTopBtn.addEventListener("click", () => {
                        window.scrollTo({
                            top: 0,
                            behavior: "smooth",
                        });
                    });
                }
            }

            // ページロード時とView Transition時に実行
            document.addEventListener("astro:page-load", initScrollEffects);
        </script>
    </body>
</html>
